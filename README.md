# 调度器基础设计

这里描述了一个面向AI/deep learning任务的、基于Kubernetes的调度器设计，调度器通过接受用户向Kubernetes系统提交的任务，将其根据当前系统资源状态以及自身属性进行排队，并最终依据预先指定的策略使得用户提交的任务依次得到执行。

调度器定义如下几个部分：调度器、用户视图、任务视图、资源视图与日志系统。调度器将通过分析资源状态、任务信息，通过调度策略，完成调度过程，并且能够根据调度历史信息，修改其调度策略，从而更好的达到预先的需求。

具体实现上，面向AI任务的、基于Kubernetes的调度器将以Kubernetes中CRD controller的形式，在系统中创建自定义任务类型的任务时，控制整个任务的生命周期，依次完成任务属性记录，分析节点情况、当前等待任务情况分析与任务与任务本身对资源的需求特点，执行调度策略，使进入等待队列并调整排队顺序，最终监控任务进入Kubernetes后的pod运行的生命周期。

调度器还能支持一些用户需求，例如支持用户实时查看任务调度状态和进度、支持用户对在调度器中的任务的生命周期的操作等等，会通过直接或者间接的形式与系统其他组件产生联系。

调度器的目标是依据系统管理员需求，改变进入系统的任务的执行顺序，并通过相应策略，尽可能避免饥饿等不利情况的出现，同时需要对任务需求与系统资源的关系做记录并调整策略，从而更好的符合系统管理员的需求。


## 调度部分

### 调度器设计

调度器维护了一个多级的任务队列，不同的队列具有不同的优先级，调度器的任务就是将来自于不同用户组、不同用户、不同优先级、不同资源需求、不同调度要求的不同任务合理高效的排列到不同的队列中，并与kubernetes的调度系统相结合，通过修改调度队列中任务的位置、修改任务属性使得用户任务按照预期策略合理的在调度队列中排队、按顺序进入到kubernetes系统，并最终在预期的节点上获得所需求的资源正常运行。运行完成后所记录的任务运行信息将与用户提交时记录的信息相比对，并对调度器以后的决策行为做出影响。

调度器中的核心功能为对提交的任务重新排序并依据预先设置的策略按次序送入Kubernetes系统中执行。

策略应该配置为多种策略，管理员可根据情况指定，每种策略都包含一个任务优先级计算的公式，通过实时计算更新任务的优先级。策略应当是根据管理员需求作出修改，并预期更好的符合管理员需求的。

策略应当考量多种因素。用户的等级、用户所属用户组的等级、所提交任务的自身的等级、任务自身的规模、用户预估任务资源占用量与预估资源使用时间、系统预估任务资源占用量与预估使用时间、任务提交时所携带的关于任务本身属性的信息、当前系统中的资源占用情况、因同时运行的其他任务而可能对其产生影响的外部因素等等都是策略应当考虑的因素，这些因素将通过量化的形式转换成一个具体的数值，最终通过加权的成为该任务在当前状态下的最终权重，该权重将成为调度系统对其进行排队先后的依据。

调度器与用户视图的联系在于，调度器要向用户提供当前任务被调度排序的依据和状态，并且根据要求向用户提供一些信息，例如预计调度上系统执行的时间等。调度器通过对用户任务中的meta信息获取到所需的当前任务的相关属性信息，从而作为调度的依据。

调度器与资源视图的联系在于，调度器通过实时获取当前系统中资源状态以及资源被使用的状态，从而依据指定的调度策略，对当前被调度任务做出调度决定。同时，调度器在将任务调度上集群并占用资源后，也将对自身的调度策略产生影响，更新调度器中的资源利用情况。

调度器与任务视图的联系在于，调度器通过直接获取、预测、分析历史记录等方式获取任务的相关信息，包括期望占用的资源情况、任务类型、可以参数化的其他选项例如神经网络类型、参数数量等，从而对该任务预期资源占用数量与时间做出预估，从而作为调度的依据。调度器从任务的meta信息中获取到与当前任务相关的任务本身的属性信息。

调度器与日志系统的联系在于，调度器需要将调度过程、决策依据、决策过程、决策结果与当前系统状态信息、任务状态信息、资源占用情况等写入日志系统，写入的内容应当足够完备，以期供离线复现。将有与调度器解耦合的日志分析与策略修改过程，目前将采用离线分析、定期更新策略的形式，将历史调度过程提供的信息作为以后优化调度系统性能的数据基础。最终，调度器将通过分析日志系统中的数据与历史任务调度信息，更好的优化自身的调度策略。

## 用户视图

用户视图包含用户的个人属性，包括用户的等级、用户所属用户组的等级、用户可以使用的资源总量与用户可同时使用的最大资源量等。这些信息将为调度器调度任务提供依据。

用户视图的内容将由系统管理员完全指定，会有独立的判断器在用户提交任务时判断提交任务后是否会超过预先设置的资源量上限，从而确保进入系统的能够被调度器看到的任务都在资源使用限额上为合法任务。资源量限制将有用户组资源量限制和用户资源量限制两个层次，用户组管理员可以为组内用户分配、修改、重新分配用户的资源量限制，组内用户总的资源量使用限制的总和不应超过该用户组的资源限制。也会有独立的计费系统等，对用户的实时资源使用量做监控，并根据需求动态调整用户使用的资源限制。

用户视图与资源视图的联系在于，用户可以获取到当前系统资源占用状态，从而影响用户对任务提交动作的决策，用户可以通过观察系统资源占用情况，在了解调度策略的情况下，提交调度器“更喜欢”的需求的任务，从而使得其任务可以被尽快执行完成。

用户视图与任务视图的联系在于，用户可以在一定限度内了解控制其所提交的任务的生命周期，例如查看自己提交的任务的调度信息与当前状态、主动终止或者重新执行任务等，用户也可以通过其他的方式与其所提交的任务做交互。用户组也在逻辑上对组内用户提交 的任务拥有相对应的权限。

用户视图与日志系统的联系在于用户视图与资源视图和任务视图的交互数据将会写入日志系统，为下一次调度提供依据。

## 资源视图

资源视图主要描述了集群与集群节点上的资源分布情况和资源使用情况。对于集群来说，集群可以根据节点上的资源类型或者管理员指定划分为多个逻辑域的概念，不同逻辑域包含着彼此独立的节点，节点可以动态的加入某个逻辑域，也可以从某个逻辑域中退出。每个域维护其内部所有的节点资源信息，从而为大任务或者具有较高优先级的任务提供快速运行的机会。对于节点来说，每个节点会动态更新其上CPU总核数与使用核数、GPU总个数与使用中的个数、GPU设备信息、GPU显存总量与使用量、内存总量与使用量、第三方设备资源的分布情况和节点类型等等信息。

资源视图定义并动态地描述了节点上的资源与资源可用性，这是集群正常工作、调度器发挥作用的数据来源。

资源视图与任务视图的联系在于，资源视图所描述的实时资源空闲情况必须要与任务视图中任务对资源的需求情况做比对，从而将任务调度到具有符合其任务视图中的资源需求的资源视图的节点上。

资源视图与日志系统的联系在于，资源系统将其资源分配动作记录下来，并需要支持获取实时的任务视图与资源视图的关系，也即支持对特定资源被哪些任务占用的实时获取。同时任务运行时资源状态可能发生变化，这也需要被记录下来，从而作为历史信息对之后任务的调度提供依据。


## 任务视图

任务视图包含了对于任务运行需求的相关信息。主要分为由用户提供的和由系统生成的。由用户定义的包含任务的ID、类型、参数、数据、特性（类似CV或者NLP）、优先级、需求的计算资源（当前由用户定义，未来可以通过系统进行预测）、任务类型，由系统生成的是由用户定义的属性生成的对资源的亲和性、预测的占用的计算资源、任务执行时间等。任务视图也描述了这个任务本身的信息。

任务视图与日志系统的联系在于提供任务的相关数据信息。调度器根据任务视图的任务信息进行调度。任务视图还需要为用户提供日志持久化的方法，从而根据用户需要或系统管理员意图，在任务的生命周期内做持久化的日志操作，例如记录下任务的状态信息、任务在队列中等待运行的等待时间、任务真实运行完成时间等等，以供后续分析并对调度器的行为产生影响。


## 日志系统

日志系统依托于Kubernetes中的持久化日志系统，对调度器各部分组件运行时产生的需要记录的信息做持久化记录，并为后续的离线分析和调度器行为优化提供数据基础。日志系统记录每个任务的Config信息，以及任务执行完成后的执行时间，对计算资源的利用信息和包括部署的节点，出现的问题在内的部署情况。

根据新产生的日志数据，改进调度器的调度策略。例如日志中记录每次任务中的多个Pod的部署情况，通过分析Pod间的协作信息，改进调度方案，改善运行效率。基于机器学习的迭代式调度方案通过获取的日志进行学习，找出对于任务性能产生影响的要素，并针对这些要素进行优化，提升整体性能。